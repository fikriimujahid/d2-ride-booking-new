name: Web-Admin CI (Dev)

# ============================================================================
# TRIGGER CONFIGURATION
# ============================================================================
on:
  pull_request:
    # Only run when PR targets 'dev' branch
    branches: [dev]
    
    # Path filter: only trigger when web-admin files change
    # Why: monorepo optimization - don't run admin CI when backend changes
    paths:
      - apps/web-admin/**

# ============================================================================
# SECURITY PERMISSIONS (Principle of Least Privilege)
# ============================================================================
permissions:
  # Read-only access to repository content
  # Frontend apps don't need write permissions in CI
  contents: read

# ============================================================================
# JOB DEFINITION
# ============================================================================
jobs:
  checks:
    if: github.event_name == 'pull_request'
    # Use Ubuntu runner (consistent with other workflows)
    runs-on: ubuntu-latest
    
    # Fail-safe: stop after 5 minutes if hung
    # Frontend builds are typically faster than backend
    timeout-minutes: 5
    
    # Set default working directory for all commands
    defaults:
      run:
        working-directory: apps/web-admin

    steps:
      # ======================================================================
      # STEP 1: CHECKOUT CODE
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch full git history for gitleaks secret scanning
          # fetch-depth: 0 = get all commits (not shallow clone)
          fetch-depth: 0

      # ======================================================================
      # STEP 2: SETUP NODE.JS ENVIRONMENT (with Caching)
      # ======================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js 20 LTS = long-term support, stable
          node-version: 20
          
          # Cache npm dependencies to speed up workflow
          # Typical speedup: 30-60 seconds per run
          cache: npm
          
          # Cache key based on package-lock.json hash
          # If dependencies change, cache is invalidated
          cache-dependency-path: apps/web-admin/package-lock.json

      # ======================================================================
      # STEP 3: INSTALL DEPENDENCIES (Clean Install)
      # ======================================================================
      - name: Install dependencies
        # npm ci = Clean Install (production-ready, reproducible)
        # Why: faster than 'npm install', uses exact versions from lock file
        run: npm ci

      # ======================================================================
      # STEP 4: CODE QUALITY - TYPE CHECKING (TypeScript)
      # ======================================================================
      - name: TypeScript check
        # Run TypeScript compiler to check types without generating files
        # Why: catches type errors before runtime (null checks, wrong types)
        # Example: passing string to function expecting number
        run: npm run typecheck

      # ======================================================================
      # STEP 5: CODE QUALITY - LINTING (ESLint)
      # ======================================================================
      - name: ESLint
        # Check code style and catch common mistakes
        # Why: enforces React best practices, accessibility rules
        # Example: missing key prop, unused state, missing dependencies
        run: npm run lint

      # ======================================================================
      # STEP 6: BUILD VERIFICATION (Vite)
      # ======================================================================
      - name: Build
        # Build production bundle with Vite
        # Why: ensures code compiles, all imports resolve, no build errors
        # Output: optimized HTML/CSS/JS bundle ready for deployment
        run: npm run build

      # ======================================================================
      # STEP 7: SECURITY - DEPENDENCY VULNERABILITIES
      # ======================================================================
      - name: Dependency scan (npm audit)
        # Scan for known vulnerabilities in npm packages
        # --production = only production deps (devDependencies excluded)
        # --audit-level=high = only fail on HIGH/CRITICAL issues
        # Why: frontend deps can have XSS, prototype pollution vulnerabilities
        run: npm audit --production --audit-level=high
      
      # ======================================================================
      # STEP 8: SECURITY - SECRET DETECTION (Gitleaks)
      # ======================================================================
      - name: Secret scan (gitleaks)
        # Scan commits for accidentally leaked secrets
        # Common frontend leaks: API keys in code, .env files committed
        uses: gitleaks/gitleaks-action@v2
        with:
          args: >-
            detect
            --redact
            -v
            --exit-code=2
            --report-format=sarif
            --report-path=results.sarif
            --log-level=debug
            --log-opts=--no-merges --first-parent
            ${{ github.event.pull_request.base.sha }}^..${{ github.event.pull_request.head.sha }}
            --
            apps/web-admin
        # Key flags:
        # --redact = hide secret values in logs (security)
        # --exit-code=2 = fail CI if secrets found (blocks merge)
        # Only scan PR commits (not entire repo history)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      # ======================================================================
      # STEP 9: SECURITY - STATIC ANALYSIS (Semgrep SAST)
      # ======================================================================
      - name: Setup Python (for Semgrep)
        # Semgrep requires Python runtime
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Semgrep (SAST)
        # Static Application Security Testing for frontend code
        # Detects: XSS vulnerabilities, insecure DOM manipulation, etc.
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          semgrep \
          --config p/default \
          --config p/typescript \
          --config p/javascript \
          --error \
          --metrics=off