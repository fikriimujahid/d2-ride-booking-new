# ============================================================================
# WEB DRIVER CI WORKFLOW - Quality & Security Checks
# ============================================================================
# Purpose: Validate driver portal code quality and security
# This is a Next.js + React + TypeScript frontend application
# ============================================================================

name: ci-web-driver

# ============================================================================
# TRIGGER CONFIGURATION
# ============================================================================
on:
  pull_request:
    # Only run when PR targets 'dev' branch
    branches: [dev]
    
    # Path filter: only trigger when web-driver files change
    # Why: in a monorepo, this prevents unnecessary CI runs
    paths:
      - apps/web-driver/**

# ============================================================================
# SECURITY PERMISSIONS (Principle of Least Privilege)
# ============================================================================
permissions:
  # Read-only access to repository content
  # Minimum permission needed for CI validation
  contents: read

# ============================================================================
# JOB DEFINITION
# ============================================================================
jobs:
  web-driver:
    # Use Ubuntu runner (standard for Node.js projects)
    runs-on: ubuntu-latest
    
    # Fail-safe timeout (Next.js builds can be slower than Vite)
    # 5 minutes is sufficient for small Next.js apps
    timeout-minutes: 5
    
    # Set default working directory to avoid 'cd' in each step
    defaults:
      run:
        working-directory: apps/web-driver

    steps:
      # ======================================================================
      # STEP 1: CHECKOUT CODE
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch full git history (not shallow clone)
          # Required for: gitleaks to scan all commits in PR
          fetch-depth: 0

      # ======================================================================
      # STEP 2: SETUP NODE.JS ENVIRONMENT (with Caching)
      # ======================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js 20 = current LTS version (stable, recommended)
          node-version: 20
          
          # Enable npm caching to speed up workflow
          # Reuses node_modules between runs if package-lock unchanged
          cache: npm
          
          # Path to lock file for cache key generation
          cache-dependency-path: apps/web-driver/package-lock.json

      # ======================================================================
      # STEP 3: INSTALL DEPENDENCIES (Clean Install)
      # ======================================================================
      - name: Install dependencies
        # npm ci = Clean Install (removes node_modules, installs from lock)
        # Why 'ci' instead of 'install':
        # - Faster in CI/CD pipelines
        # - Reproducible (exact versions from package-lock.json)
        # - Fails if package.json and lock file don't match (catches errors)
        run: npm ci

      # ======================================================================
      # STEP 4: CODE QUALITY - TYPE CHECKING (TypeScript)
      # ======================================================================
      - name: TypeScript check
        # Run TypeScript compiler to validate types
        # Why: catches type errors before code reaches production
        # Next.js apps: ensures pages/components are type-safe
        run: npm run typecheck

      # ======================================================================
      # STEP 5: CODE QUALITY - LINTING (ESLint)
      # ======================================================================
      - name: ESLint
        # Lint code for style issues and common mistakes
        # Next.js ESLint includes: React hooks rules, Core Web Vitals
        # Example catches: missing alt text, improper link usage
        run: npm run lint

      # ======================================================================
      # STEP 6: BUILD VERIFICATION (Next.js)
      # ======================================================================
      - name: Build
        env:
          # Disable Next.js telemetry in CI (privacy, cleaner logs)
          # Next.js collects anonymous usage data by default
          NEXT_TELEMETRY_DISABLED: '1'
        # Build production Next.js bundle
        # Why: verifies all pages compile, no missing imports/exports
        # Next.js performs: route validation, image optimization, bundling
        run: npm run build

      # ======================================================================
      # STEP 7: SECURITY - DEPENDENCY VULNERABILITIES
      # ======================================================================
      - name: Dependency scan (npm audit)
        # Scan npm packages for known security vulnerabilities
        # --production = only check production deps (not devDependencies)
        # --audit-level=high = fail only on HIGH/CRITICAL severity
        # Why: Next.js apps can have vulnerabilities in React, image libs, etc.
        run: npm audit --production --audit-level=high

      # ======================================================================
      # STEP 8: SECURITY - SECRET DETECTION (Gitleaks)
      # ======================================================================
      - name: Secret scan (gitleaks)
        # Scan git commits for accidentally committed secrets
        # Common in frontend: API keys, Firebase config, Auth0 secrets
        uses: gitleaks/gitleaks-action@v2
        with:
          args: >-
            detect
            --redact
            -v
            --exit-code=2
            --report-format=sarif
            --report-path=results.sarif
            --log-level=debug
            --log-opts=--no-merges --first-parent
            ${{ github.event.pull_request.base.sha }}^..${{ github.event.pull_request.head.sha }}
            --
            apps/web-driver
        # Critical flags:
        # --redact = mask secrets in logs (don't expose them)
        # --exit-code=2 = fail workflow if secrets found (blocks PR merge)
        # Scan only PR commits (base SHA to head SHA range)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ======================================================================
      # STEP 9: SECURITY - STATIC ANALYSIS (Semgrep SAST)
      # ======================================================================
      - name: Setup Python (for Semgrep)
        # Semgrep is written in Python, requires Python runtime
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Semgrep (SAST)
        # SAST = Static Application Security Testing
        # Scans source code for security vulnerabilities without running it
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          semgrep \
          --config p/default \
          --config p/typescript \
          --config p/javascript \
          --error \
          --metrics=off
        # Rule configurations:
        # p/default = generic security rules (XSS, code injection)
        # p/typescript = TypeScript-specific patterns
        # p/javascript = JavaScript security issues (eval, dangerouslySetInnerHTML)
        # --error = treat findings as errors (fail CI)
        # --metrics=off = disable analytics (privacy)

