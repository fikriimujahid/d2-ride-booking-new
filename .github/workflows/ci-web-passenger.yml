# ============================================================================
# WEB PASSENGER CI WORKFLOW - Quality & Security Checks
# ============================================================================
# Purpose: Validate passenger portal code quality and security
# This is a Next.js + React + TypeScript frontend application
# ============================================================================

name: ci-web-passenger

# ============================================================================
# TRIGGER CONFIGURATION
# ============================================================================
on:
  pull_request:
    # Only run when PR targets 'dev' branch
    branches: [dev]
    
    # Path filter: only trigger when web-passenger files change
    # Why: monorepo efficiency - avoids running CI for unrelated changes
    paths:
      - apps/web-passenger/**

# ============================================================================
# SECURITY PERMISSIONS (Principle of Least Privilege)
# ============================================================================
permissions:
  # Read-only access to repository content
  # This is the minimum permission needed for CI checks
  # No write access = more secure (can't modify code or secrets)
  contents: read

# ============================================================================
# JOB DEFINITION
# ============================================================================
jobs:
  web-passenger:
    # Use Ubuntu runner (standard, well-supported, cost-effective)
    runs-on: ubuntu-latest
    
    # Fail-safe: terminate job after 5 minutes if it hangs
    # Prevents: runaway costs, stuck pipelines blocking other PRs
    timeout-minutes: 5
    
    # Set default working directory for all 'run' steps
    # Eliminates need to 'cd apps/web-passenger' in every command
    defaults:
      run:
        working-directory: apps/web-passenger

    steps:
      # ======================================================================
      # STEP 1: CHECKOUT CODE
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch full git history (all commits and branches)
          # Why: gitleaks needs commit history to scan for secrets
          # fetch-depth: 0 = complete history (not shallow clone)
          fetch-depth: 0

      # ======================================================================
      # STEP 2: SETUP NODE.JS ENVIRONMENT (with Caching)
      # ======================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js 20 = LTS (Long Term Support) version
          # Why: stability, security updates, same version as production
          node-version: 20
          
          # Enable npm dependency caching
          # Cache hit = skip downloading packages (saves 30-60 seconds)
          cache: npm
          
          # Path to package-lock.json for cache key generation
          # If lock file changes = cache miss, re-download dependencies
          cache-dependency-path: apps/web-passenger/package-lock.json

      # ======================================================================
      # STEP 3: INSTALL DEPENDENCIES (Clean Install)
      # ======================================================================
      - name: Install dependencies
        # npm ci = Clean Install (production best practice)
        # vs 'npm install':
        # ✓ Faster (skips dependency resolution)
        # ✓ Reproducible (uses exact versions from package-lock.json)
        # ✓ Safer (fails if lock file is out of sync with package.json)
        run: npm ci

      # ======================================================================
      # STEP 4: CODE QUALITY - TYPE CHECKING (TypeScript)
      # ======================================================================
      - name: TypeScript check
        # Run TypeScript compiler in type-check mode (no output files)
        # Why: catches type errors that would cause runtime bugs
        # Examples: null/undefined access, wrong prop types, missing returns
        run: npm run typecheck

      # ======================================================================
      # STEP 5: CODE QUALITY - LINTING (ESLint)
      # ======================================================================
      - name: ESLint
        # Run ESLint to enforce code style and catch common mistakes
        # Next.js ESLint config includes:
        # - React hooks rules (proper useState/useEffect usage)
        # - Accessibility checks (a11y)
        # - Performance best practices (Core Web Vitals)
        run: npm run lint

      # ======================================================================
      # STEP 6: BUILD VERIFICATION (Next.js Production Build)
      # ======================================================================
      - name: Build
        env:
          # Disable Next.js anonymous telemetry collection
          # Why: privacy in CI, cleaner logs, no external network calls
          NEXT_TELEMETRY_DISABLED: '1'
        # Build production-optimized Next.js bundle
        # What this does:
        # - Compiles TypeScript to JavaScript
        # - Bundles and minifies code
        # - Optimizes images
        # - Generates static pages (if using SSG)
        # Why: ensures app can build before deploying
        run: npm run build

      # ======================================================================
      # STEP 7: SECURITY - DEPENDENCY VULNERABILITIES (npm audit)
      # ======================================================================
      - name: Dependency scan (npm audit)
        # Scan npm dependencies for known security vulnerabilities
        # Uses npm's vulnerability database
        # --production = only check runtime deps (ignore devDependencies)
        # --audit-level=high = only fail on HIGH or CRITICAL issues
        # Why: passenger-facing app needs secure dependencies (data privacy)
        run: npm audit --production --audit-level=high
      
      # ======================================================================
      # STEP 8: SECURITY - SECRET DETECTION (Gitleaks)
      # ======================================================================
      - name: Secret scan (gitleaks)
        # Scan git commits for accidentally committed secrets
        # Critical for passenger app: API keys, Firebase config, auth tokens
        uses: gitleaks/gitleaks-action@v2
        with:
          args: >-
            detect
            --redact
            -v
            --exit-code=2
            --report-format=sarif
            --report-path=results.sarif
            --log-level=debug
            --log-opts=--no-merges --first-parent
            ${{ github.event.pull_request.base.sha }}^..${{ github.event.pull_request.head.sha }}
            --
            apps/web-passenger
        # Key flags explained:
        # detect = scan mode (vs protect mode)
        # --redact = hide secret values in output (don't leak in logs)
        # --exit-code=2 = fail workflow if secrets found (blocks PR)
        # base.sha^..head.sha = only scan commits in this PR (not entire repo)
        # -- apps/web-passenger = limit scan to this directory
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      # ======================================================================
      # STEP 9: SECURITY - STATIC ANALYSIS (Semgrep SAST)
      # ======================================================================
      - name: Setup Python (for Semgrep)
        # Semgrep is a Python-based security scanner
        uses: actions/setup-python@v5
        with:
          # Python 3.11 = modern, stable, fast
          python-version: '3.11'

      - name: Semgrep (SAST)
        # SAST = Static Application Security Testing
        # Analyzes source code for security vulnerabilities (without running it)
        # Detects: XSS, injection flaws, insecure patterns
        run: |
          # Upgrade pip to latest version (best practice)
          python -m pip install --upgrade pip
          
          # Install Semgrep security scanner
          pip install semgrep
          
          # Run Semgrep with multiple security rule sets
          semgrep \
          --config p/default \
          --config p/typescript \
          --config p/javascript \
          --error \
          --metrics=off
        # Rule sets explained:
        # p/default = general security rules (OWASP Top 10 patterns)
        # p/typescript = TypeScript-specific vulnerabilities
        # p/javascript = JS security issues (eval, innerHTML, DOM XSS)
        # --error = treat all findings as errors (fail CI if issues found)
        # --metrics=off = disable usage analytics (privacy, GDPR compliance)
