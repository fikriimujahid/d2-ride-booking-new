name: Backend API Deploy (Prod)

on:
  push:
    branches:
      - main
    paths:
      - apps/backend-api/**
      - infra/scripts/deploy-*-prod.sh
      - infra/scripts/deploy-service-rolling.sh
  workflow_dispatch:
    inputs:
      release_id:
        description: "Rollback/redeploy an existing artifact RELEASE_ID (leave blank to build+deploy new)."
        required: false
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: backend-api-prod
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy NestJS Backend API to ASG via SSM (Prod)
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve release id
        id: artifact
        run: |
          set -e
          if [ -n "${{ inputs.release_id }}" ]; then
            echo "release_id=${{ inputs.release_id }}" >> $GITHUB_OUTPUT
            echo "[info] Using existing RELEASE_ID=${{ inputs.release_id }}"
          else
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            echo "release_id=$TIMESTAMP" >> $GITHUB_OUTPUT
            echo "[info] Generated RELEASE_ID=$TIMESTAMP"
          fi

      - name: Setup Node.js
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.release_id == '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/backend-api/package-lock.json

      - name: Install dependencies
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.release_id == '' }}
        working-directory: apps/backend-api
        run: npm ci

      - name: Build NestJS backend api
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.release_id == '' }}
        working-directory: apps/backend-api
        run: npm run build

      - name: Prune devDependencies (artifact only)
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.release_id == '' }}
        working-directory: apps/backend-api
        run: npm prune --omit=dev

      - name: Package deployment artifact
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.release_id == '' }}
        run: |
          set -e
          RELEASE_ID="${{ steps.artifact.outputs.release_id }}"
          mkdir -p artifact
          rm -rf artifact/*

          cp -r apps/backend-api/dist artifact/
          cp -r apps/backend-api/node_modules artifact/
          cp apps/backend-api/ecosystem.config.js artifact/
          cp apps/backend-api/package*.json artifact/

          tar -czf backend-api-$RELEASE_ID.tar.gz -C artifact .
          sha256sum backend-api-$RELEASE_ID.tar.gz > backend-api-$RELEASE_ID.sha256

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Upload artifact to S3
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.release_id == '' }}
        run: |
          RELEASE_ID="${{ steps.artifact.outputs.release_id }}"
          aws s3 cp backend-api-$RELEASE_ID.tar.gz \
            s3://${{ vars.S3_BUCKET_ARTIFACT }}/apps/backend/backend-api-$RELEASE_ID.tar.gz
          aws s3 cp backend-api-$RELEASE_ID.sha256 \
            s3://${{ vars.S3_BUCKET_ARTIFACT }}/apps/backend/backend-api-$RELEASE_ID.sha256

      - name: Deploy to ASG instances using SSM (rolling, no SSH)
        run: |
          export AWS_REGION="${{ vars.AWS_REGION }}"
          export S3_BUCKET_ARTIFACT="${{ vars.S3_BUCKET_ARTIFACT }}"
          export RELEASE_ID="${{ steps.artifact.outputs.release_id }}"
          export ENVIRONMENT="prod"
          export PROJECT_NAME="d2-ride-booking"

          bash infra/scripts/deploy-backend-api-prod.sh
