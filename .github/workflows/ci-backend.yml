# ============================================================================
# BACKEND API CI WORKFLOW - Quality & Security Checks
# ============================================================================
# Purpose: Validate backend code quality, run tests, and security scans
# This ensures backend changes meet standards before merging
# ============================================================================

name: ci-backend

# ============================================================================
# TRIGGER CONFIGURATION
# ============================================================================
on:
  pull_request:
    branches: [dev]
    paths:
      - apps/backend-api/**
  push:
    branches: [dev]
    paths:
      - apps/backend-api/**
  workflow_dispatch:

# ============================================================================
# SECURITY PERMISSIONS (Principle of Least Privilege)
# ============================================================================
permissions:
  # Read-only access to repository content
  # This is the MINIMUM permission needed for CI checks
  # Why: prevents compromised workflow from modifying code
  contents: read

# ============================================================================
# JOB DEFINITION
# ============================================================================
jobs:
  backend:
    # Use Ubuntu runner (most common, well-supported for Node.js)
    runs-on: ubuntu-latest
    
    # Fail-safe: stop job after 5 minutes if hung
    # Why: prevents runaway costs and stuck workflows
    # 5 minutes is generous for backend build + tests
    timeout-minutes: 5
    
    # Set default working directory for all 'run' commands
    # Avoids repeating 'cd apps/backend-api' in every step
    defaults:
      run:
        working-directory: apps/backend-api

    steps:
      # ======================================================================
      # STEP 1: CHECKOUT CODE
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch full git history (not shallow clone)
          # Why: needed for gitleaks to scan all commits in PR
          # fetch-depth: 0 means "get all commits and branches"
          fetch-depth: 0

      # ======================================================================
      # STEP 2: SETUP NODE.JS ENVIRONMENT (with Caching)
      # ======================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Pin to Node.js 20 LTS for consistency
          # Why: same version in dev, CI, and production = fewer bugs
          node-version: 20
          
          # Enable npm dependency caching
          # Why: speeds up workflow by 30-60 seconds (reuses node_modules)
          cache: npm
          
          # Path to package-lock.json for cache key generation
          # If lock file changes, cache is invalidated (new dependencies)
          cache-dependency-path: apps/backend-api/package-lock.json

      # ======================================================================
      # STEP 3: INSTALL DEPENDENCIES (Reproducible)
      # ======================================================================
      - name: Install dependencies
        # npm ci = Clean Install (deletes node_modules, installs from lock file)
        # Why 'ci' not 'install':
        # - Faster in CI (skips dependency resolution)
        # - Reproducible (exact versions from package-lock.json)
        # - Fails if package.json and package-lock.json are out of sync
        run: npm ci

      # ======================================================================
      # STEP 4: CODE QUALITY - LINTING (ESLint)
      # ======================================================================
      - name: ESLint
        # Run ESLint to check code style and catch common errors
        # Why: enforces consistent code style, catches bugs before runtime
        # Examples: unused variables, missing await, == vs ===
        run: npm run lint
      
      # ======================================================================
      # STEP 5: CODE QUALITY - TYPE CHECKING (TypeScript)
      # ======================================================================
      - name: TypeScript type check
        # Run TypeScript compiler in type-check mode (no JS output)
        # Why: catches type errors that ESLint might miss
        # Example: passing wrong type to function, null reference errors
        run: npm run typecheck
      
      # ======================================================================
      # STEP 6: AUTOMATED TESTING
      # ======================================================================
      - name: Unit tests
        # Run Jest unit tests
        # Why: ensures code changes don't break existing functionality
        # Tests run in CI catch bugs before code review
        run: npm test

      # ======================================================================
      # STEP 7: BUILD VERIFICATION
      # ======================================================================
      - name: Build
        # Compile TypeScript to JavaScript (production build)
        # Why: catches build errors early (missing imports, TS errors)
        # If it doesn't build, it can't deploy
        run: npm run build

      # ======================================================================
      # STEP 8: SECURITY - DEPENDENCY VULNERABILITIES (npm audit)
      # ======================================================================
      - name: Dependency scan (npm audit)
        # Scan npm dependencies for known security vulnerabilities
        # --production = only check production dependencies (not devDependencies)
        # --audit-level=high = fail only on HIGH or CRITICAL vulnerabilities
        # Why: catches vulnerable packages (e.g., old lodash with prototype pollution)
        run: npm audit --production --audit-level=high
        
      # ======================================================================
      # STEP 9: SECURITY - SECRET DETECTION (Gitleaks)
      # ======================================================================
      - name: Secret scan (gitleaks)
        # Scan git commits for accidentally committed secrets
        # Examples: API keys, passwords, AWS credentials, private keys
        if: github.event_name == 'pull_request'
        uses: gitleaks/gitleaks-action@v2
        with:
          args: >-
            detect
            --redact
            -v
            --exit-code=2
            --report-format=sarif
            --report-path=results.sarif
            --log-level=debug
            --log-opts=--no-merges --first-parent
            ${{ github.event.pull_request.base.sha }}^..${{ github.event.pull_request.head.sha }}
            --
            apps/backend-api
        # Explanation of args:
        # detect = scan for secrets
        # --redact = hide secret values in output (don't expose them in logs)
        # --exit-code=2 = fail workflow if secrets found
        # --report-format=sarif = standard format for security tools
        # ${{...base.sha}}^..${{...head.sha}} = only scan PR commits (not entire history)
        # -- apps/backend-api = only scan backend directory
        env:
          # Token needed to access PR metadata
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # ======================================================================
      # STEP 10: SECURITY - STATIC APPLICATION SECURITY TESTING (Semgrep)
      # ======================================================================
      - name: Setup Python (for Semgrep)
        # Semgrep is a Python tool, so we need Python installed
        uses: actions/setup-python@v5
        with:
          # Python 3.11 = stable, fast, good Semgrep support
          python-version: '3.11'

      - name: Semgrep (SAST)
        # SAST = Static Application Security Testing
        # Scans code for security vulnerabilities and anti-patterns
        run: |
          # Upgrade pip to latest (best practice)
          python -m pip install --upgrade pip
          
          # Install Semgrep security scanner
          pip install semgrep
          
          # Run Semgrep with multiple rule sets
          semgrep \
          --config p/default \
          --config p/nodejs \
          --config p/typescript \
          --error \
          --metrics=off
        # Explanation of flags:
        # --config p/default = general security rules (SQL injection, XSS, etc.)
        # --config p/nodejs = Node.js-specific rules (eval() misuse, etc.)
        # --config p/typescript = TypeScript-specific patterns
        # --error = fail workflow if security issues found
        # --metrics=off = disable usage analytics (privacy) 

  deploy-dev:
    name: Deploy backend to DEV EC2 via SSM (no SSH)
    needs: backend
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend-api

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/backend-api/package-lock.json

      - name: Build artifact
        run: |
          npm ci
          npm run build
          tar -czf backend-api.tar.gz dist package.json package-lock.json .env.example

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::731099197523:role/github-actions-deploy-role
          aws-region: 'ap-southeast-1'

      - name: Upload artifact to S3 (used by SSM command)
        run: aws s3 cp backend-api.tar.gz s3://${{ secrets.DEV_ARTIFACT_BUCKET }}/backend/backend-api.tar.gz

      - name: Deploy via SSM Run Command (no SSH)
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy backend API without SSH (SSM tunnel)" \
            --instance-ids "${{ secrets.DEV_BACKEND_INSTANCE_ID }}" \
            --parameters commands='[
              "set -euxo pipefail",
              "aws s3 cp s3://${{ secrets.DEV_ARTIFACT_BUCKET }}/backend/backend-api.tar.gz /tmp/backend-api.tar.gz",
              "sudo mkdir -p /opt/backend-api",
              "sudo tar -xzf /tmp/backend-api.tar.gz -C /opt/backend-api",
              "cd /opt/backend-api && sudo npm ci --omit=dev",
              "sudo systemctl enable backend-api.service",
              "sudo systemctl restart backend-api.service"
            ]'

      - name: Post-deploy reminder
        run: echo "Deployment triggered via SSM Run Command; validate /health over ALB or SSM port-forward."
